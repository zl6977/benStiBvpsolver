// crt_popen.c
/* This program uses _popen and _pclose to receive a
* stream of text from a system process.
*/

#include <stdio.h>
#include <stdlib.h>

int main(void)
{

   char psBuffer[128];
   FILE *pPipe;

   /* Run DIR so that it writes its output to a pipe. Open this
         * pipe with read text attribute so that we can read it
         * like a text file.
         */

   char *pipecmd = "awholefile.exe 0.3 0.7 0.18 0.2 0.1 2.3 0.2 1e4 4.5e6 2e4 0.52 >curvetmp.txt";
   if ((pPipe = _popen(pipecmd, "r")) == NULL)
      exit(1);
   pipecmd = "gnuplot -persist -e \"plot 'curvetmp.txt' u 1:3 w l\"";
   if ((pPipe = _popen(pipecmd, "r")) == NULL)
      exit(1);

   /* Read pipe until end of file, or an error occurs. */

   while (fgets(psBuffer, 128, pPipe))
   {
      printf(psBuffer);
   }

   /* Close pipe and print return value of pPipe. */
   if (feof(pPipe))
   {
      printf("\nProcess returned %d\n", _pclose(pPipe));
   }
   else
   {
      printf("Error: Failed to read the pipe to the end.\n");
   }
}